<!DOCTYPE html>
<html>
    <head>
        <title>XMLHTTPRequest API</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
        <style type="text/css">
            h2, textarea, input, div {
                width: 40%;
                margin-left: 4%;
                margin-right: 4%;
                display: inline-block;
            }
            form {
                border: dashed 1px turquoise;
                padding: 20px;
            }
            #displayarea, iframe {
                width: 1000px;
                height: 600px;
                border: solid 1px grey;
            }
            h4 {
                display: inline-block;
            }
            #status {
                width: auto;
            }
        </style>
    </head>

    <body>
        <h1>XMLHTTPRequest API</h1>

        <form>
            <h2>Request:</h2>
            <h2>Response:</h2>
            <br>
            <textarea name="reqbody" id="request" rows="10"></textarea>
            <textarea name="resbody" id="response" rows="10"></textarea>
            <br>
            <!--div id="displayarea">
                
            </div>
            <iframe src=""></iframe-->
            <div></div>
            <div>
                <h4>Status code:</h4>
                <input type="text" name="status" id="status" readonly="readonly">
                <button type="button" onclick="newWindow()">Render response in new window</button>
            </div>
            
            <h3>URL</h3>
            <input type="url" name="url">
            <h3>Select method</h3>
            <select id="method">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
            <h3>Select parse</h3>
            <select id="parse">
                <option value="JSON">JSON</option>
                <option value="HTML">HTML</option>
                <option value="text">text</option>
            </select>
            <input type="submit">
        </form>

        <script type="text/javascript">
        $('form').submit(e => {
            e.preventDefault();
            console.log(e);

            var settings = {
                url: $('input').val(),
                method: $('#method').val(),
                data: $('#request').val() ? $.parseJSON($('#request').val()) : null,
                crossDomain: true
            };
            console.log(settings);

            $.ajax(settings).always((body, status, jqXHR) => {
                console.log(body);

                var format = $('#parse').val();
                console.log(format);
                
                if ( format == "JSON" ) {
                    $('#response').text( JSON.stringify(body) );
                } else if ( format == "HTML" || "text") {
                    // parser = new DOMParser();
                    // htmlDoc = parser.parseFromString(response,"text/html");
                    $('#response').text(body);
                }

                $('#status').text(status);
                console.log(jqXHR);
                alert(jqXHR);
                /*
                var length = response.split("").length;
                for (var i = 0; i+7 < length; i++) {
                    if (response.substring(i, i+6) == "<body>") {
                        response = response.slice(0, i) + `<div id="contents">` + response.slice(i+6);
                    }
                    if (response.substring(i, i+7) == "</body>") {
                        response = response.slice(0, i) + "</div>" + response.slice(i+7);
                    }
                }
                var a;
                var b;
                for (var i = 0; i+8 < length; i++) {
                    if (response.substring(i, i+7) == "<style>") {
                        a = i+7;
                    }
                    if (response.substring(i, i+8) == "</style>") {
                        b = i;
                    }
                }
                for (var i = a; i < b; i++) {
                    if (response.substring(i, i+4) == "body") {
                        response = response.slice(0, i) + "#contents {height: 250px; width: 250px;}" + response.slice(i+4);
                    }
                }
                $(response).find('<style>').css("height", "300px");
                */
                
                // $('div').html(response);
                
                // $('iframe').attr("src", settings.url);
            });
        });
        
        var newWindow = function(event) {
            // alert("Disable the pop-up blocker");
            var myWindow = window.open("", "MsgWindow", "width=800,height=500");
            myWindow.document.write( $('#response').val() );
        }
        </script>
    </body>
</html>
